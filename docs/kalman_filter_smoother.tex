\documentclass[12pt]{article}
\usepackage{amsthm,amsfonts,amsmath,xcolor,fullpage}
\usepackage[letterpaper, margin=1in]{geometry}

\setlength{\parindent}{0pt}

\newcommand{\Gt}{G_\theta}
\newcommand{\vecop}[0]{\text{vec}}
\newcommand{\Cov}[0]{\text{Cov}}
\newcommand{\Var}[0]{\text{Var}}
\newcommand{\flag}[0]{red}

\begin{document}

\section*{Kalman Filtering and Smoothing Calculations}
	Using the preferred timing for the state space model,
	\begin{align*} 
	y_t = Z_t \alpha_t + d_t + \epsilon_t &\qquad \epsilon_t \sim N(0,H_t) \\ 
	\alpha_{t} = T_t \alpha_{t-1} + c_t + R_t \eta_t &\qquad \eta_t \sim N(0, Q_t)
	\end{align*} 

	the filtered estimates are given by 
	\begin{align*}
	a_{t+1} = T_{t+1} a_t + c_{t+1} + K_t v_t &\qquad
	P_{t+1} = T_{t+1} P_t L_t^\prime + R_{t+1} Q_{t+1} R_{t+1}^\prime \\
	v_t = y_t - Z_ta_t - d_t &\qquad
	K_t = T_{t+1} P_t Z_t^\prime F_t^{-1} \\
	F_t = Z_t P_t Z_t^\prime + H_t &\qquad
	L_t = T_{t+1} - K_t Z_t 
	\end{align*} 

	and the smoothed estimates are given by
	\begin{align*}
	\hat{\alpha}_t = a_t + P_t r_t &\qquad V_t = P_t - P_t N_t P_t \\ 
	r_t = Z_t^\prime F_t^{-1} v_t + L_t^\prime r_{t+1} &\qquad N_{t} = Z_t^\prime F_t^{-1} Z_t + L_t^\prime N_{t+1} L_t
	\end{align*}
	where $r_{n+1} = 0$ and $N_{n+1} = 0$. 

	\subsubsection*{Univariate Filter}
	When any $H_t$ is non-diagonal, the observation equation is transformed by taking the LDL factorization of the $H_t$ matrices:
	\begin{align*}
	y_t^* = Z_t^* \alpha_t + d_t^* + \epsilon_t^* &\qquad \epsilon_t \sim N(0, H_t^*)\\
	y_t^* = C_t^{-1} y_t \qquad Z_t^* = C_t^{-1} Z_t \qquad d_t^* &= C_t^{-1} d_t \qquad \epsilon_t^* = C_t^{-1} \epsilon_t \qquad H_t = C_t H_t^* C_t^\prime
	\end{align*}

	To avoid taking the inverse of $F_t$ in the above recursion, several quantities are computed using the univariate filter that can be used on this transformed system: 
	\begin{align*}
	a_{t, i+1} = a_{t,i} + K_{t,i} v_{t,i}^* &\qquad P_{t,i+1} = P_{t,i} - K_{t,i} F_{t,i} K_{t,i}^{\prime} \\
	v_{t,i}^* = y_{t,i}^* - Z_{t,i}^* a_{t,i} - d_{t,i}^* \qquad F_{t,i} &= Z_{t,i}^* P_{t,i} Z_{t,i}^{*\prime} + H_{t,i}^* \qquad K_{t,i} = P_{t,i} Z_{t,i}^{*\prime} F_{t,i}^{-1} \\ 
	a_{t+1,1} = T_{t+1} a_{t, p+1} + c_{t+1} &\qquad P_{t+1,1} = T_{t+1} P_{t,p+1} T_{t+1}^\prime + R_{t+1} Q_{t+1} R_{t+1}^\prime
	\end{align*}
	where $Z_{t,i}^*$ is the $i$th row of $Z_t^*$, $d_{t,i}^*$ is the $i$th element of $d_t^*$, and $H_{t,i}^*$ is the $i$th diagonal element of $H_t^*$. The filtered estimates of the state $a_t = a_{t,1}$ and $P_t = P_{t,1}$ are equivalent to those computed above. Similarly, the univariate smoother provides $r_t = r_{t,0}$ and $N_t = N_{t,0}$:
	\begin{align*}
	r_{t,i-1} = Z_{t,i}^{*\prime} F_{t,i}^{-1} v_{t,i}^* + L_{t,i}^{\prime} r_{t,i} \qquad N_{t,i-1} =& Z_{t,i}^{*\prime} F_{t,i}^{-1} Z_{t,i}^* + L_{t,i}^{\prime} N_{t,i} L_{t,i} \qquad L_{t,i} = I_m - K_{t,i} Z_{t,i}^* F_{t,i}^{-1}\\
	r_{t-1,p} = T_{t}^\prime r_{t,0} &\qquad N_{t-1,p} = T_{t-1}^\prime N_{t,0} T_{t-1}
	\end{align*}
	where $r_{t+1,p} = 0$ and $N_{t+1,p} = 0$. \\

\subsubsection*{Exact Initial Kalman Filter}
	When the state $\alpha_t$ is stationary, the initial values $a_0$ and $P_0$ can be computed as the unconditional mean and variance of the state given the system parameters: 
	\begin{align*}
	a_0 &= (I_m - T_0)^{-1} c_0 \\
	\vecop(P_0) &= (I_{m^2} - T_0 \otimes T_0)^{-1} \vecop(R_0 Q_0 R_0^\prime) 
	\end{align*}

	In cases where the state $\alpha_t$ is nonstationary, the state is separated into stationary components and nonstationary components via the eigenvalues of the $T_0$ matrix -- states associated with an eigenvalue less than one in absolute value are considered stationary while those with an eigenvalue greater than one are diffuse. The initial values are given by 
	\begin{align*}
	a_0 = a + R_0 \eta_0 + A \delta \qquad \eta_0 &\sim N(0, Q_0) \qquad \delta \sim N(0, \kappa I) \\
	P_0 = P_{*,0} + \kappa P_{\infty,0} \qquad P_{*,0} &= R_0 Q_0 R_0^\prime \qquad P_{\infty,0} = A A^\prime
	\end{align*}
	The unconditional mean of the stationary states is computed as $a_0$ was above and placed in $a$ with any elements of $a$ associated with diffuse states set to 0. The unconditional variance of the stationary states, $Q_0$, is computed as $P_0$ was in the stationary case. The selection matrix $R_0$ is composed of columns of the identity matrix such that the initial shock $\eta_0$ is applied to the stationary states. The selection matrix $A$ is composed of the columns of the identity matrix associated with the diffuse states such that taking the limit as $\kappa \rightarrow \infty$ allows for states with infinite initial variance. \\

	The univariate filter recursions must be altered to separate the states with finite v. infinite variances: 
	\begin{align*}
	 F_{*,t,i} = Z_{t,i}^* P_{*,t,i} Z_{t,i}^{*\prime} + H_{t,i}^* &\qquad F_{\infty,t,i} = Z_{t,i}^* P_{\infty,t,i} Z_{t,i}^{*\prime}\\
	K_{*,t,i} = P_{*,t,i} Z_{t,i}^{*\prime} &\qquad K_{\infty,t,i} = P_{\infty,t,i} Z_{t,i}^{*\prime} 
	\end{align*}
	\begin{equation*}
	a_{t,i+1} = \begin{cases} 
	      a_{t,i} + K_{*,t,i} F_{*,t,i}^{-1} v_{t,i}^* & F_{\infty,t,i} = 0 \\
	      a_{t,i} + K_{\infty,t,i} F_{\infty,t,i}^{-1} v_{t,i}^* & F_{\infty,t,i} \neq 0
    \end{cases} 
    \end{equation*}
	\begin{equation*}
	P_{*,t,i+1} = \begin{cases} 
	   P_{*,t,i} - K_{*,t,i} K_{*,t,i}^\prime F_{*,t,i}^{-1} & F_{\infty,t,i} = 0 \\
	   P_{*,t,i} + K_{\infty,t,i} K_{\infty,t,i}^\prime F_{*,t,i} F_{\infty,t,i}^{-2} - (K_{*,t,i} K_{\infty,t,i}^\prime + K_{\infty,t,i} K_{*,t,i}^\prime) F_{\infty,t,i}^{-1} & F_{\infty,t,i} \neq 0
	\end{cases}
	\end{equation*}
	\begin{equation*}
	P_{\infty,t,i+1} = \begin{cases} 
	   P_{\infty,t,i} & F_{\infty,t,i} = 0 \\
	   P_{\infty,t,i} - K_{\infty,t,i} K_{\infty,t,i}^\prime F_{\infty,t,i}^{-1} & F_{\infty,t,i} \neq 0	   
	\end{cases} 
	\end{equation*}
	\begin{align*}
	a_{t+1,1} &= T_{t+1} a_{t, p+1} + c_{t+1} \\
	P_{\infty,t+1,1} = T_{t+1} P_{\infty,t,p+1} T_{t+1}^\prime &\qquad P_{*,t+1,1} = T_{t+1} P_{*,t,p+1} T_{t+1}^\prime + R_{t+1} Q_{t+1} R_{t+1}^\prime 
	\end{align*}
	For any set of system parameters where the state can be identified, there exists some time $d$ such that $F_{\infty,d,i} = 0$ for all $i$. For time $t > d$, the simpler Kalman filter recursion above can be employed. \\

	The smoother must be similarly altered so that beginning at $t = d$, the computation of $r_{t,i}$ is expanded to account for the initialization:
	\begin{align*}
	L_{\infty,t,i} = I_m - K_{\infty,t,i} Z_{t,i}^* F_{\infty,t,i}^{-1} &\qquad
	L_{*,t,i} = I_m - K_{*,t,i} Z_{t,i}^* F_{*,t,i}^{-1} \\
	L_{t,i}^{(0)} = \left(K_{\infty,t,i} F_{*,t,i} F_{\infty,t,i}^{-1} - K_{*,t,i} \right) Z_{t,i}^* F_{\infty,t,i}^{-1} &
	\end{align*}
	\begin{equation*}
	r_{t,i-1}^{(0)} = \begin{cases} 
	   Z_{t,i}^{*\prime} F_{*,t,i}^{-1} v_{t,i}^* + L_{*,t,i}^\prime r_{t,i}^{(0)} & F_{\infty,t,i} = 0 \\
	   L_{\infty,t,i}^\prime r_{t,i}^{(0)} & F_{\infty,t,i} \neq 0	   
	\end{cases} 
	\end{equation*}
	\begin{equation*}
	r_{t,i-1}^{(1)} = \begin{cases} 
	   r_{t,i}^{(1)} & F_{\infty,t,i} = 0 \\
	   Z_{t,i}^{*\prime} F_{\infty,t,i}^{-1} v_{t,i}^* + L_{t,i}^{(0)\prime} r_{t,i}^{(0)} + L_{\infty,t,i}^\prime r_{t,i}^{(1)} & F_{\infty,t,i} \neq 0	   
	\end{cases} 
	\end{equation*}
	\begin{equation*}
	r_{t-1,p}^{(0)} = T_t^\prime r_{t,0}^{(0)} \qquad r_{t-1,p}^{(1)} = T_t^\prime r_{t,0}^{(1)}  \\
	\end{equation*}
	\begin{equation*}
	\hat{\alpha}_t = a_t + P_{*,t,1} r_{t,0}^{(0)} + P_{\infty,t,1} r_{t,0}^{(1)}
	\end{equation*}
	where $r_{d,p}^{(0)} = r_{d,p}$ and $r_{d,p}^{(1)} = 0$. Note that $L_{\infty,t,i}$ and $L_{t,i}^{(0)}$ only need to be computed when $F_{\infty,t,i} \neq 0$ and $L_{*,t,i}$ only needs to be computed when $F_{\infty,t,i} = 0$. \\

	For the smoothed variance of the state, 
	\begin{align*}
	V_t = P_{*,t,1} - P_{*,t,1} N_{t,0}^{(0)} P_{*,t,1} - \left(P_{\infty,t,1} N_{t,0}^{(1)} P_{*,t,1} \right)^\prime &- P_{\infty,t,1} N_{t,0}^{(1)} P_{*,t,1} - P_{\infty,t,1} N_{t,0}^{(2)} P_{\infty,t,1} \\
	N_{t-1,p}^{(0)} = T_t^\prime N_{t,0}^{(0)} T_t \qquad
	N_{t-1,p}^{(1)} = T_t^\prime N_{t,0}^{(1)} T_t &\qquad
	N_{t-1,p}^{(2)} = T_t^\prime N_{t,0}^{(1)} T_t 
	\end{align*}
	where when $F_{\infty,t,i} = 0$, 
	\begin{align*}
	N_{t,i-1}^{(0)} = Z_{t,i}^{*\prime} F_{*,t,i}^{-1} Z_{t,i}^* + L_{*,t,i}^\prime N_{t,i}^{(0)} L_{*,t,i} &\qquad
	N_{t,i-1}^{(1)} = N_{t,i}^{(1)} &\qquad
	N_{t,i-1}^{(2)} = N_{t,i}^{(2)} 
	\end{align*}
	and when $F_{\infty,t,i} \neq 0$,
	\begin{align*}
	N_{t,i-1}^{(0)} &= L_{\infty,t,i}^\prime N_{t,i}^{(0)} L_{\infty,t,i}\\
	N_{t,i-1}^{(1)} &= Z_{t,i}^{*\prime} F_{\infty,t,i}^{-1} Z_{t,i}^* + L_{\infty,t,i}^\prime N_{t,i}^{(0)} L_{t,i}^{(0)} + L_{\infty,t,i}^\prime N_{t,i}^{(1)} L_{\infty,t,i}  \\
	N_{t,i-1}^{(2)} &= Z_{t,i}^{*\prime} F_{\infty,t,i}^{-2} Z_{t,i}^* F_{*,t,i} + L_{t,i}^{(0)\prime} N_{t,i}^{(1)} L_{t,i}^{(0)} + L_{\infty,t,i}^\prime N_{t,i}^{(1)} L_{t,i}^{(0)} + L_{t,i}^{(0)\prime} N_{t,i}^{(1)} L_{\infty,t,i} + L_{\infty,t,i}^\prime N_{t,i}^{(2)} L_{\infty,t,i}
	\end{align*}
	where $N_{d,p}^{(0)} = N_{d,p}$ and $N_{d,p}^{(1)} = N_{d,p}^{(2)} = 0$. \\


% \subsubsection*{Other definitions}
% 	\begin{align*}
% 	{\color{\flag} u_t = F_t^{-1} v_t + K_t^\prime r_t} &\qquad 
% 	{\color{\flag} D_t = F_t^{-1} K_t^\prime N_t K_t} \\
% 	\hat{\eta_t} = Q_t R_t^\prime r_t &\qquad \Var(\eta_t | Y_n) = Q_t - Q_t R_t^\prime N_t R_t Q_t \\
% 	J_t = \Cov(\alpha_{t+1}, \alpha_t | Y_n) &= P_t L_t (I_m - N_t P_{t+1})
% 	\end{align*}

\newpage
\section*{Likelihood Calculation}
	The likelihood of of data $y_1, \dots, y_n$ is given by
	\begin{equation*} 
	\text{log} L(Y_n) \equiv -\frac{np}{2} \log(2\pi) - \frac{1}{2}  \sum_{t=1}^n \log|F_t| + v_t^\prime F_t^{-1}v_t
	\end{equation*}

% $\partial [\vecop(A)^\prime] / \partial \theta = \Gt(A)$

\subsection*{Univariate Gradient}

	% Using an alternative form of the likelihood calculation, 
	% \begin{equation*}
	% \text{log} L(Y_n) \equiv -\frac{np}{2} \log(2\pi) - \frac{1}{2}  \sum_{t=1}^n \log|H_t| + \hat{\epsilon}_t^\prime H_t^{-1} \hat{\epsilon}_t + \log|Q_t| + \hat{\eta}_t^\prime Q_t^{-1} \hat{\eta}_t
	% \end{equation*}

	From Jungbacker, Koopman \& van der Wel (2011), the gradient of the likelihood can be computed without taking the inverse of $F_t$ provided the smoothed estimates are computed. The gradient of the likelihood $L_n$ with respect to each parameter matrix is (note, wrong timing, corrected for naming differences):

	\begin{align*}
	\frac{\partial L_n}{\partial Z_t} &= H_t^{-1} \left[(y_t - d_t)\hat{\alpha}_t^\prime - Z_t M_{Z_t} \right] \\
	\frac{\partial L_n}{\partial d_t} &= H_t^{-1} (y_t - Z_t \hat{\alpha}_t - d_t) \\
	\frac{\partial L_n}{\partial H_t} &= H_t^{-1} M_{H_t} H_t^{-1} - \frac{1}{2} \text{diag} \left\{ H_t^{-1} M_{H_t} H_t^{-1}\right\} \\
	\frac{\partial L_n}{\partial T_t} &= \bar{R}_t^\prime Q_t^{-1} \bar{R}_t (M_{T_t} - T_t M_{Z_t}) \\
	\frac{\partial L_n}{\partial c_t} &= \bar{R}_t^\prime Q_t^{-1} \bar{R}_t (\hat{\alpha}_{t+1} - T_t \hat{\alpha}_t - c_t) \\
	\frac{\partial L_n}{\partial Q_t} &= Q_t^{-1} M_{Q_t} Q_t^{-1} - \frac{1}{2} \text{diag} \left\{ Q_t^{-1} M_{Q_t} Q_t^{-1} \right\} \\
	\end{align*}

	where 
	\begin{align*}
	M_{Z_t} &= \hat{\alpha}_t \hat{\alpha}_t^\prime + V_t\\
	M_{H_t} &= (y_t - Z_t \hat{\alpha}_t) (y_t - Z_t \hat{\alpha}_t)^\prime + Z_t V_t Z_t^\prime - H_t \\
	M_{T_t} &= \hat{\alpha}_t \hat{\alpha}_t^\prime + J_t\\
	M_{Q_t} &= \mathbb{E}(\eta_t \eta_t^\prime | y_1, \dots, y_n) - Q_t
	\end{align*}

	\newpage
	Jungbacker \& Koopman (2015), also have a formulation of the gradient but do so with time-invariant matricies without mean adjustments. Starting from the likelihood function 
	\begin{align*}
	L_n = c - \frac{n}{2} \log |H| - \frac{1}{2} \text{tr} M_H - \frac{n-1}{2} \log |Q| - \frac{1}{2} \text{tr} M_Q \\ 
	- \frac{1}{2} \log |P| - \frac{1}{2} \text{tr} \left(P^{-1} ((\hat{\alpha}_1 - a) (\hat{\alpha}_1 - a)^\prime + V_1) \right)
	\end{align*}
	they produce parameter gradients (with a fair amount of guessing on my part for the timing)
	\begin{align*}
	\frac{\partial L_n}{\partial Z_t} &= H_t^{-1} \left[y_t\hat{\alpha}_t^\prime - Z_t M_{Z_t} \right] \\
	\frac{\partial L_n}{\partial H_t} &= H_t^{-1} M_{H_t} H_t^{-1} - \frac{1}{2} \text{diag} \left\{ H_t^{-1} M_{H_t} H_t^{-1}\right\} \\
	\frac{\partial L_n}{\partial T_t} &= Q_t^{-1} (M_{T_t} - T_t M_{Z_t}) \qquad (\text{or is this } M_{Z_{t-1}}?) \\
	\frac{\partial L_n}{\partial Q_t} &= Q_t^{-1} M_{Q_t} Q_t^{-1} - \frac{1}{2} \text{diag} \left\{ Q_t^{-1} M_{Q_t} Q_t^{-1} \right\} 
	\end{align*}
	where 
	\begin{align*}
	M_{Z_t} &= \hat{\alpha}_t \hat{\alpha}_t^\prime + V_t\\
	M_{H_t} &= \hat{\epsilon}_t \hat{\epsilon}_t^\prime + \Var(\epsilon_t | Y_n, \theta) \\
	M_{T_t} &= \hat{\alpha}_t \hat{\alpha}_t^\prime + J_t\\
	M_{Q_t} &= \hat{\eta}_t \hat{\eta}_t^\prime + \Var(\eta_t | Y_n, \theta) 
	\end{align*}

\newpage
\subsection*{Multivariate Gradient}
	From Nagakura (working paper), we can get the gradient:
	\begin{align*}
	\Gt(\ell_t) &= \Gt(a_t) Z_t' w_t  \\
	 &+ \frac{1}{2} \Gt(P_t) \vecop (Z_t^\prime w_t w_t^\prime Z_t - Z_t^\prime F_t^{-1} Z_t) \\
	 &+ \Gt(d_t) w_t \\
	 &+ \Gt(Z_t) \vecop (w_t a_t^\prime + w_t v_t^\prime M_t^\prime - M_t^\prime) \\
	 &+ \frac{1}{2} \Gt(H_t) \vecop (w_t w_t^\prime - F_t^{-1})
	\end{align*}

	where 
	\begin{align*}
	\Gt(a_{t+1}) &= \Gt(a_t)L_t^\prime \\ 	
	 &+ \Gt(P_t) (Z_t^\prime w_t \otimes L_t^\prime) \\
	 &+ \Gt(c_{t+1}) \\
	 &- \Gt(d_t) K_t^\prime \\ 
	 &+ \Gt(Z_t) [P_tL_t^\prime \otimes w_t - (a_t + M_t v_t) \otimes K_t^\prime] \\
	 &- \Gt(H_t) (w_t \otimes K_t^\prime) \\ 
	 &+ \Gt(T_{t+1})[(a_t + M_t v_t) \otimes I_m]
	\end{align*}
	\begin{align*}
	\Gt(P_{t+1}) &= \Gt(P_t) (L_t^\prime \otimes L_t^\prime) \\
	 &+ \Gt(H_t)(K_t^\prime \otimes K_t^\prime) \\
	 &+ \Gt(Q_{t+1})(R_{t+1}^\prime \otimes R_{t+1}^\prime) \\
	 &+ [\Gt(T_{t+1})(P_t L_t^\prime \otimes I_m) \\
	 &\qquad - \Gt(Z_t)(P_t L_t^\prime \otimes K_t^\prime) \\
	 &\qquad + \Gt(R_{t+1})(Q_{t+1}R_{t+1}^\prime \otimes I_m) ] N_m
	\end{align*}


	The initial conditions for the recursion are given by a simplification of the expressions above (which can also be easily derived from the explicit expressions for $a_1$ and $P_1$): 
	\begin{align*}
	\Gt(a_1) &= \Gt(a_0) T_1^\prime \\ 
	 &+ \Gt(c_1)  \\
	 &+ \Gt(T_1)[a_0 \otimes I_m]
	\end{align*}
	\begin{align*}
	\Gt(P_1) &= \Gt(P_0) (T_t^\prime \otimes T_t^\prime) \\
	 &+ \Gt(Q_1)(R_1^\prime \otimes R_1^\prime) \\
	 &+ [\Gt(T_1)(P_0 T_1^\prime \otimes I_m) \\
	 &\qquad + \Gt(R_1)(Q_1 R_1^\prime \otimes I_m) ] N_m
	\end{align*}


	To determine $\Gt(a_0)$ and $\Gt(P_0)$ when $a_0$ and $P_0$ are set as the unconditional mean and variance of the state (i.e., when they are not explicitly provided and the system is stationary) use the definitions of the unconditional state:
	\begin{align*}
	a_0 &= (I_m - T)^{-1} c \\
	\Gt(a_0) &= \Gt([I_m - T]^{-1} c) \\ 
		&= \Gt([I_m - T]^{-1}) (c \otimes I_m) + \Gt(c) (I_1 \otimes [(I_m - T)^{-1})]^\prime \\ 
		&= -\Gt(I_m - T) [(I_m - T)^{-1} \otimes (I_m - T)^{-1} ](c \otimes I_m) +  \Gt(c) (I_m - T)^{\prime-1} \\ 
		&= \Gt(T) [(I_m - T)^{-1} \otimes (I_m - T)^{-1}] (c \otimes I_m) +  \Gt(c) (I_m - T)^{\prime-1} 
	\end{align*}
	\begin{align*}
	\vecop(P_0) &= (I_{m^2} - T \otimes T)^{-1} \vecop(RQR^\prime) \\ 
	\Gt(P_0) &= \Gt(\vecop(P_0)) \\
		&= \Gt(S \ \vecop(RQR^\prime))\\
		&= \Gt(S) [\vecop(RQR^\prime) \otimes I_{m^2}] + \Gt(\vecop(RQR^\prime))(I_1 \otimes S^\prime) \\
		&= -\Gt(I_{m^2} - T \otimes T)(S \otimes S^\prime) [\vecop(RQR^\prime) \otimes I_{m^2}]\\ 
		&\qquad + [\Gt(R)(QR^\prime \otimes I_m) N_m + \Gt(Q)(R^\prime \otimes R^\prime)] S^\prime \\
		&= \Gt(T \otimes T)(S \otimes S^\prime) [\vecop(RQR^\prime) \otimes I_{m^2}] \\
		&\qquad + [\Gt(R)(QR^\prime \otimes I_m) N_m + \Gt(Q)(R^\prime \otimes R^\prime)] S^\prime
	\end{align*}
	where $S = (I_{m^2} - T \otimes T)^{-1}$. Note that $\Gt(T \otimes T)$ must be computed separately.

	% \section*{Derivation}

	% It's clear that the gradient of the total likelihood with respect to the parameters, 
	% \begin{align}
	% \ell_t = -\frac{p}{2} \log(2\pi) - \frac{1}{2} \log|F_t| + v_t^\prime F_t^{-1}v_t
	% \end{align}
	% can be divided by time period:
	% \begin{align*}
	% \frac{\partial L_n}{\partial \theta} = \sum_{t=1}^{n} \frac{\partial \ell_t}{\partial \theta} = \sum_{t=1}^{n} \frac{\partial v_t^\prime}{\partial \theta} \frac{\partial \ell_t}{\partial v_t^\prime}
	% \end{align*}


\end{document}

